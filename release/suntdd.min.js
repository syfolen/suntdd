var __extends=this&&this.__extends||function(){var i=function(t,e){i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return i(t,e)};return function(t,e){i(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}}();var suntdd;(function(t){var n;(function(t){t[t["CONNECTED"]=0]="CONNECTED";t[t["CONNECTING"]=1]="CONNECTING";t[t["DISCONNECTED"]=2]="DISCONNECTED"})(n=t.MSWSConnectionStateEnum||(t.MSWSConnectionStateEnum={}));var i;(function(t){t[t["CONNECTED"]=0]="CONNECTED";t[t["CLOSE"]=1]="CLOSE";t[t["ERROR"]=2]="ERROR"})(i=t.MSWSStateEnum||(t.MSWSStateEnum={}));var r;(function(t){t[t["NONE"]=0]="NONE";t[t["BUTTON_CLICK"]=1]="BUTTON_CLICK";t[t["SIGNAL_EMIT"]=2]="SIGNAL_EMIT";t[t["SIGNAL_WAIT"]=3]="SIGNAL_WAIT";t[t["WS_STATE"]=4]="WS_STATE";t[t["WS_PROTOCAL"]=5]="WS_PROTOCAL"})(r=t.TestActionKindEnum||(t.TestActionKindEnum={}));var s;(function(t){t[t["NONE"]=1]="NONE";t[t["NOT_YET"]=2]="NOT_YET";t[t["COMPLETE"]=4]="COMPLETE";t[t["SUSPEND"]=8]="SUSPEND"})(s=t.TestActionResultEnum||(t.TestActionResultEnum={}));var o;(function(t){t[t["INSERT"]=0]="INSERT";t[t["APPEND"]=1]="APPEND"})(o=t.TestCaseRegOptionEnum||(t.TestCaseRegOptionEnum={}));var u;(function(t){t[t["PREPARE"]=0]="PREPARE";t[t["EXECUTE"]=1]="EXECUTE";t[t["FINISH"]=2]="FINISH"})(u=t.TestCaseStatusEnum||(t.TestCaseStatusEnum={}));var a=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t){delete _.buttonMap[t];var e=_.waitMap[t]||null;if(e===null){return}for(var n=0;n<e.length;n++){var i=e[n];if(i.line===true){continue}i.canceled=true}};return e}(puremvc.SimpleCommand);t.CancelCommand=a;var c=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t){var e={id:t};this.facade.sendNotification(N.ADD_ACTION,[r.BUTTON_CLICK,e])};return e}(puremvc.SimpleCommand);t.ClickCommand=c;var d=function(e){__extends(t,e);function t(){var t=e!==null&&e.apply(this,arguments)||this;t.$click=null;t.$button=null;return t}t.prototype.execute=function(t){this.$click=t;this.$button=_.buttonMap[t.id]||null;suncom.Test.expect(this.$button).not.toBeNull();if(this.$button.once===true){delete _.buttonMap[t.id]}suncore.System.addTimer(suncore.ModuleEnum.SYSTEM,500,this.$doClick,this)};t.prototype.$doClick=function(){var t=new Laya.Event;t.setTo(Laya.Event.CLICK,this.$button.button,this.$button.button);this.$button.button.event(Laya.Event.CLICK,t);this.$click.done=true};return t}(puremvc.SimpleCommand);t.DoClickCommand=d;var f=function(e){__extends(t,e);function t(){var t=e!==null&&e.apply(this,arguments)||this;t.$cfg=null;return t}t.prototype.execute=function(t){this.$cfg=t;suncom.Test.expect(t.id).toBeGreaterThan(0);if(t.delay<=0){this.$doEmit()}else{suncore.System.addTimer(suncore.ModuleEnum.SYSTEM,t.delay,this.$doEmit,this)}};t.prototype.$doEmit=function(){suncom.Test.expect(_.currentSignalId).interpret("信号发射干扰").toBe(0);_.currentSignalId=this.$cfg.id;var t=_.waitMap[this.$cfg.id]||null;if(t!==null){for(var e=0;e<t.length;e++){var n=t[e];if(n.once===true&&n.done===true){continue}if(n.once===true){n.done=true}if(n.canceled===true){continue}var i=n.handler||null;if(i===null){continue}i.runWith(this.$cfg.args)}}this.$cfg.done=true;_.currentSignalId=0};return t}(puremvc.SimpleCommand);t.DoEmitCommand=f;var T=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t,e,n,i){var o={id:t,args:e,line:n,delay:i};if(n===false){this.facade.sendNotification(N.DO_EMIT,o)}else{this.facade.sendNotification(N.ADD_ACTION,[r.SIGNAL_EMIT,o])}};return e}(puremvc.SimpleCommand);t.EmitCommand=T;var e=function(e){__extends(t,e);function t(){var t=e.call(this,0)||this;t.$actions=[];_.timeDiff=suncom.Mathf.random(-8e3,8e3);if(suncore.System.isModuleStopped(suncore.ModuleEnum.SYSTEM)===true){throw Error("微服务器未运行，因为SYSTEM时间轴未开启")}return t}t.prototype.$onRun=function(){this.facade.registerCommand(N.EMIT,T);this.facade.registerCommand(N.WAIT,h);this.facade.registerCommand(N.CLICK,c);this.facade.registerCommand(N.CANCEL,a);this.facade.registerCommand(N.DO_EMIT,f);this.facade.registerCommand(N.DO_CLICK,d);this.facade.registerCommand(N.REG_BUTTON,l);this.facade.registerCommand(N.PREPARE_PROTOCAL_PACKET,E);this.facade.registerCommand(N.SERIALIZE_WEBSOCKET_STATE_PACKET,p);this.facade.registerCommand(N.SERIALIZE_WEBSOCKET_PROTOCAL_PACKET,C);this.facade.registerObserver(N.ADD_WAIT,this.$addWait,this);this.facade.registerObserver(N.ADD_ACTION,this.$addAction,this);this.facade.registerObserver(N.TEST_WEBSOCKET_SEND_DATA,this.$onWebSocketSendData,this)};t.prototype.$onStop=function(){this.facade.removeCommand(N.EMIT);this.facade.removeCommand(N.WAIT);this.facade.removeCommand(N.CLICK);this.facade.removeCommand(N.CANCEL);this.facade.removeCommand(N.DO_EMIT);this.facade.removeCommand(N.DO_CLICK);this.facade.removeCommand(N.REG_BUTTON);this.facade.removeCommand(N.PREPARE_PROTOCAL_PACKET);this.facade.removeCommand(N.SERIALIZE_WEBSOCKET_STATE_PACKET);this.facade.removeCommand(N.SERIALIZE_WEBSOCKET_PROTOCAL_PACKET);this.facade.removeObserver(N.ADD_WAIT,this.$addWait,this);this.facade.removeObserver(N.ADD_ACTION,this.$addAction,this);this.facade.removeObserver(N.TEST_WEBSOCKET_SEND_DATA,this.$onWebSocketSendData,this)};t.prototype.$frameLoop=function(){var t=false;while(this.$actions.length>0){var e=this.$actions[0];var n=s.NONE;switch(e.kind){case r.SIGNAL_WAIT:n=this.$doWait(e.cfg);break;case r.SIGNAL_EMIT:n=this.$doEmit(e.cfg);break;case r.BUTTON_CLICK:n=this.$doClick(e.cfg);break;case r.WS_STATE:n=this.$notifyStatePacket(e.cfg);break;case r.WS_PROTOCAL:n=this.$notifyProtocalPacket(e.cfg);break;default:suncom.Test.notExpected();break}if(n&s.NOT_YET){break}if(n&s.COMPLETE){this.$actions.shift()}if(n&s.SUSPEND){break}if(e.kind===r.WS_PROTOCAL){t=true}if(t===true&&this.$actions.length>0){var i=this.$actions[0];if(i.kind===r.WS_PROTOCAL){var o=i.cfg;if(o.asNewMsg===true){break}}}}if(this.$actions.length>0){return}if(_.currentTestCase===null){var a=_.tccQueue.shift()||null;_.currentTestCase=a===null?null:new a.taskCls(a.tcId)}else if(_.currentTestCase.status===u.EXECUTE){_.currentTestCase.done()}else if(_.currentTestCase.status===u.FINISH){suncom.Test.expect(this.$actions.length).toBe(0);_.currentTestCase=null}};t.prototype.$onWebSocketSendData=function(t){for(var e=0;e<this.$actions.length;e++){var n=this.$actions[e];if(n.kind===r.WS_PROTOCAL){var i=n.cfg;if(i.waitName===t&&i.waitTimes>0&&i.waitCount<i.waitTimes){i.waitCount++}break}}};t.prototype.$addAction=function(t,e){var n={kind:t,cfg:e};this.$actions.push(n)};t.prototype.$addWait=function(t){var e=_.waitMap[t.id]||null;if(e===null){e=_.waitMap[t.id]=[]}var n=-1;for(var i=0;i<e.length;i++){if(e[i]===t){n=i;break}}if(n===-1){e.push(t)}};t.prototype.$notifyProtocalPacket=function(t){if(this.$notYet(t)===true){return s.NOT_YET}this.facade.sendNotification(N.PREPARE_PROTOCAL_PACKET,t);this.facade.sendNotification(N.TEST_WEBSOCKET_PROTOCAL,[t.replyName,t.data]);if(t.repeatTimes===1){return s.COMPLETE}t.repeatTimes--;t.waitCount=0;delete t.createTime;return s.SUSPEND};t.prototype.$notifyStatePacket=function(t){var e={name:t.connName,state:n.DISCONNECTED};this.facade.sendNotification(N.GET_WEBSOCKET_INFO,e);if(e.state===n.DISCONNECTED){return s.NOT_YET}if(this.$notYet(t)===true){return s.NOT_YET}if(e.state===n.CONNECTING){suncom.Test.assertTrue(t.state===i.CONNECTED||t.state===i.ERROR,"当前网络正在连接，仅允许下行CONNECTED或ERROR状态")}else if(e.state===n.CONNECTED){suncom.Test.assertTrue(t.state===i.CLOSE||t.state===i.ERROR,"当前网络己连接，仅允许下行CLOSE或ERROR状态")}this.facade.sendNotification(N.TEST_WEBSOCKET_STATE,t.state);return s.COMPLETE&s.SUSPEND};t.prototype.$notYet=function(t){if(t.waitName!==null&&t.waitCount<t.waitTimes){return true}if(t.createTime===void 0){t.createTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}if(t.createTime+t.delay>suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)){return true}if(t.asNewMsg===true&&t.createTime===suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)){return true}return false};t.prototype.$doClick=function(t){if(t.actTime===void 0){if(_.buttonMap[t.id]===void 0){return s.NOT_YET}t.actTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.facade.sendNotification(N.DO_CLICK,t);return s.NONE}else if(t.done===true){return s.COMPLETE}else{return s.NOT_YET}};t.prototype.$doEmit=function(t){if(t.done===true){return s.COMPLETE}if(t.actTime===void 0){t.actTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.facade.sendNotification(N.DO_EMIT,t)}else{return s.NOT_YET}return s.NONE};t.prototype.$doWait=function(t){if(t.done===true){return s.COMPLETE}if(t.actTime===void 0){t.actTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.$addWait(t)}else{return s.NOT_YET}return s.NONE};return t}(suncore.BaseService);t.MicroService=e;var E=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t){if(t.data===null){return}for(var e=0;e<t.hashFileds.length;e++){this.$setFieldValue(t.data,t.hashFileds[e],suncom.Common.createHashId())}for(var e=0;e<t.timeFields.length;e++){var n=t.timeFields[e];var i=(new Date).valueOf()+_.timeDiff+n.arg1;this.$setFieldValue(t.data,n.arg2,dcodeIO.Long.fromNumber(i))}};e.prototype.$setFieldValue=function(t,e,n){var i=e.split(".");while(i.length>1){t=t[i.shift()]}t[i.shift()]=n};return e}(puremvc.SimpleCommand);t.PrepareProtocalPacketCommand=E;var l=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t,e,n){suncom.Test.expect(e).anything();suncom.Test.expect(_.buttonMap[t]).toBeUndefined();var i={button:e,once:n};_.buttonMap[t]=i};return e}(puremvc.SimpleCommand);t.RegButtonCommand=l;var m=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.$initializePacket=function(t){if(t.delay===void 0){t.delay=0}if(t.connName===void 0){t.connName="default"}if(t.asNewMsg===void 0){t.asNewMsg=true}if(t.waitName===void 0){t.waitName=null}if(t.waitTimes===void 0){t.waitTimes=1}t.waitCount=0;suncom.Test.expect(t.delay).interpret("消息下行延时必须大于或等于0").toBeGreaterOrEqualThan(0);suncom.Test.expect(t.waitTimes).interpret("消息上行等待次数必须大于0").toBeGreaterThan(0)};e.prototype.$initializePacketDefaultValue=function(t,e,n){if(e===void 0){e=[]}if(n===void 0){n=[]}if(t.data===null){return}t.hashFileds=n;t.timeFields=[];for(var i=0;i<e.length;i++){var o=this.$getFieldValue(t.data,e[i],0);t.timeFields.push({arg1:o,arg2:e[i]})}};e.prototype.$getFieldValue=function(t,e,n){var i=e.split(".");while(i.length>0){t=t[i.shift()]}return t===void 0?n:t};return e}(puremvc.SimpleCommand);t.SerializeWebSocketPacketCommand=m;var C=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t,e,n){this.$initializePacket(t);if(t.data===void 0){t.data=null}if(t.replyName===void 0){t.replyName=null}if(t.repeatTimes===void 0){t.repeatTimes=1}this.$initializePacketDefaultValue(t,e,n);suncom.Test.expect(t.repeatTimes).interpret("消息的下行次数必须大于或等于1").toBeGreaterOrEqualThan(1);this.facade.sendNotification(N.ADD_ACTION,[r.WS_PROTOCAL,t])};return e}(m);t.SerializeWebSocketProtocalPacketCommand=C;var p=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t){this.$initializePacket(t);suncom.Test.expect(t.state).interpret("必须指定WebSocket状态包的状态值").not.toBeUndefined();this.facade.sendNotification(N.ADD_ACTION,[r.WS_STATE,t])};return e}(m);t.SerializeWebSocketStatePacketCommand=p;var S=function(n){__extends(t,n);function t(t){var e=n.call(this,0)||this;e.$status=u.PREPARE;e.$caseId=t;_.currentTestCase=e;suncore.System.addMessage(suncore.ModuleEnum.SYSTEM,suncore.MessagePriorityEnum.PRIORITY_0,suncom.Handler.create(e,e.$doPrepare));return e}t.prototype.done=function(){this.$afterAll();this.$status=u.FINISH};t.prototype.$doPrepare=function(){this.$status=u.EXECUTE;this.$beforeAll()};t.prototype.$addTest=function(t,e,n){if(n===void 0){n=o.APPEND}var i={tcId:t,taskCls:e};if(n===o.APPEND){_.tccQueue.push(i)}else{_.tccQueue.unshift(i)}};t.prototype.$describe=function(t){suncom.Logger.log(suncom.DebugMode.TDD,t)};t.prototype.$beforeAll=function(){};t.prototype.$afterAll=function(){};t.prototype.$emit=function(t,e,n){if(n===void 0){n=0}this.facade.sendNotification(N.EMIT,[t,e,true,n])};t.prototype.$wait=function(t,e,n,i){if(e===void 0){e=null}if(n===void 0){n=true}if(i===void 0){i=true}if(n===true){i=true}else{suncom.Test.expect(e).interpret("当参数line为false时必须指定handler").toBeInstanceOf(suncom.Handler)}this.facade.sendNotification(N.WAIT,[t,e,n,i])};t.prototype.$click=function(t){this.facade.sendNotification(N.CLICK,t)};t.prototype.$cancel=function(t){this.facade.sendNotification(N.CANCEL,t)};t.prototype.$serializeWebSocketStatePacket=function(t){this.facade.sendNotification(N.SERIALIZE_WEBSOCKET_STATE_PACKET,t)};t.prototype.$serializeWebSocketProtocalPacket=function(t,e,n,i){t.data=e;this.facade.sendNotification(N.SERIALIZE_WEBSOCKET_STATE_PACKET,[t,n,i])};Object.defineProperty(t.prototype,"status",{get:function(){return this.$status},enumerable:true,configurable:true});return t}(puremvc.Notifier);t.TestCase=S;var h=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.execute=function(t,e,n,i){var o={id:t,handler:e,line:n,once:i};if(n===true){this.facade.sendNotification(N.ADD_ACTION,[r.SIGNAL_WAIT,o])}else{this.facade.sendNotification(N.ADD_WAIT,o)}};return e}(puremvc.SimpleCommand);t.WaitCommand=h;var _;(function(t){t.timeDiff=0;t.currentSignalId=0;t.currentTestCase=null;t.tccQueue=[];t.waitMap={};t.buttonMap={}})(_=t.M||(t.M={}));var N;(function(t){t.EMIT="suntdd.NotifyKey.EMIT";t.WAIT="suntdd.NotifyKey.WAIT";t.DO_EMIT="suntdd.NotifyKey.DO_EMIT";t.CANCEL="suntdd.NotifyKey.CANCEL";t.CLICK="suntdd.NotifyKey.CLICK";t.DO_CLICK="suntdd.NotifyKey.DO_CLICK";t.REG_BUTTON="suntdd.NotifyKey.REG_BUTTON";t.ADD_WAIT="suntdd.NotifyKey.ADD_WAIT";t.ADD_ACTION="suntdd.NotifyKey.ADD_ACTION";t.GET_WEBSOCKET_INFO="suntdd.NotifyKey.GET_WEBSOCKET_INFO";t.TEST_WEBSOCKET_STATE="suntdd.NotifyKey.TEST_WEBSOCKET_STATE";t.TEST_WEBSOCKET_PROTOCAL="suntdd.NotifyKey.TEST_WEBSOCKET_PROTOCAL";t.TEST_WEBSOCKET_SEND_DATA="suntdd.NotifyKey.TEST_WEBSOCKET_SEND_DATA";t.PREPARE_PROTOCAL_PACKET="suntdd.NotifyKey.PREPARE_PROTOCAL_PACKET";t.SERIALIZE_WEBSOCKET_STATE_PACKET="suntdd.NotifyKey.SERIALIZE_WEBSOCKET_STATE_PACKET";t.SERIALIZE_WEBSOCKET_PROTOCAL_PACKET="suntdd.NotifyKey.SERIALIZE_WEBSOCKET_PROTOCAL_PACKET"})(N=t.NotifyKey||(t.NotifyKey={}));var O;(function(t){function e(t,e,n){if(n===void 0){n=0}puremvc.Facade.getInstance().sendNotification(N.EMIT,[t,e,false,n])}t.emit=e;function n(t,e,n){if(n===void 0){n=true}puremvc.Facade.getInstance().sendNotification(N.REG_BUTTON,[t,e,n])}t.regButton=n})(O=t.Test||(t.Test={}))})(suntdd||(suntdd={}));